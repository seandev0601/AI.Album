# 技術規格文件 (TechSpec.md) - 照片故事 Metadata 功能

> 版本: 1.1
> 日期: 2025-05-22
> PBI: [照片添加故事文字讀寫功能](./AlbumPBI.md)
> Task Breakdown: [Task.md](./Task.md)

---

## 1. 簡介

本文件定義了「照片添加故事文字讀寫功能」的技術規格。此功能允許使用者為其照片添加、儲存及讀取文字故事，這些故事將被嵌入到照片的 Metadata 中。

## 2. 系統架構

本功能為 iOS App 的一部分，主要在客戶端進行處理。

*   **UI 層 (SwiftUI)**: 負責使用者介面展示、使用者輸入、照片選擇及與後端邏輯互動。
*   **業務邏輯層**: 處理照片權限、Metadata 讀寫、字數限制、錯誤處理等。
*   **資料存取層**: 使用 PhotoKit 與系統相簿互動，並讀寫照片檔案的 Metadata。

## 3. 資料模型

### 3.1. PhotoStory

用於表示照片故事的領域模型。

```swift
struct PhotoStory {
    let id: String // 照片的本地標識符 (e.g., localIdentifier from PHAsset)
    var story: String? // 故事內容，最多 300 字
}
```

### 3.2. Metadata 儲存

*   **儲存位置**: 照片的 Metadata 資訊區塊（依序嘗試 TIFF、EXIF、IPTC）。
*   **自訂 Metadata Key**: 使用 `ai.album.story` 作為儲存故事內容的唯一鍵名。此鍵名及其他相關常數應定義在 `Config.swift` 檔案中統一管理。

## 4. 核心功能與 API 設計 (內部 Utilities)

### 4.1. 相簿權限管理 (PhotoKit)

*   **功能**: 請求並驗證使用者對手機相簿的存取權限。
*   **流程**:
    1.  App 首次啟動或需要存取相簿時，向使用者顯示系統權限請求彈窗。
    2.  根據使用者的選擇（允許/拒絕）處理後續流程。
    3.  若權限被拒絕或限制，需提供友善提示。

### 4.2. Metadata 讀取 Utility

*   **功能**: 從指定照片檔案讀取已儲存的故事內容。
*   **介面 (概念性)**:
    ```swift
    func readStory(from photoAsset: PHAsset) async throws -> String?
    ```
*   **輸入**: `PHAsset` 物件 (或其他照片標識符)。
*   **輸出**:
    *   成功: 返回儲存在 `ai.album.story` 鍵下的故事字串 (String?)。若無故事則返回 `nil`。
    *   失敗: 拋出錯誤 (參見 6. 錯誤處理)。
*   **支援格式**: 初期主要支援 JPG, PNG, JPEG。若遇到其他格式 (如 HEIC)，應提示格式暫不支援 (詳見 6. 錯誤處理)。
*   **邏輯**:
    1.  取得照片的完整影像資料。
    2.  解析 Metadata (TIFF/EXIF/IPTC)。
    3.  查找 `ai.album.story` 鍵，提取其值。

### 4.3. Metadata 寫入 Utility

*   **功能**: 將使用者輸入的故事內容寫入指定照片檔案的 Metadata。
*   **介面 (概念性)**:
    ```swift
    func writeStory(_ story: String, to photoAsset: PHAsset) async throws
    ```
*   **輸入**:
    *   `story`: 故事內容 (String)，最多 300 字。
    *   `photoAsset`: `PHAsset` 物件 (或其他照片標識符)。
*   **輸出**:
    *   成功: 完成寫入。
    *   失敗: 拋出錯誤 (參見 6. 錯誤處理)。
*   **支援格式**: 初期主要支援 JPG, PNG, JPEG。若遇到其他格式 (如 HEIC)，應提示格式暫不支援 (詳見 6. 錯誤處理)。
*   **檔案處理策略**:
    1.  初期嘗試直接覆蓋原照片檔案。
    2.  此覆蓋操作需進行至少5次嚴格的儲存測試。若在這些測試中發生任何一次檔案損毀或資料遺失的情況，則必須立即轉換為非破壞性編輯方案（例如，先將修改儲存至 App 的私有沙盒，待成功後再請求 PhotoKit 更新資產）或提供「另存為」新照片的選項。
*   **邏輯**:
    1.  檢查故事內容是否超過 300 字限制 (UI層應已做限制，此處為最終防護)。
    2.  提示使用者「儲存後將覆蓋原照片檔案，是否繼續？」並獲取確認。
    3.  取得照片的完整影像資料。
    4.  將故事內容以 `ai.album.story` 為鍵名寫入 Metadata (TIFF/EXIF/IPTC)。
    5.  儲存修改後的照片檔案，覆蓋原檔。

## 5. 技術棧

*   **開發工具**: Xcode 16.2
*   **UI 框架**: SwiftUI
*   **目標作業系統**: iOS 17
*   **相簿存取**: PhotoKit
*   **本地化**: `Localizable.strings` 檔案支援 `zh-Hant` (繁體中文) 和 `en` (英文)。
*   **常數管理**: 透過 `Config.swift` 檔案統一管理專案中的常數 (例如 Metadata 鍵名 `ai.album.story`)。

## 6. 錯誤處理

將定義一個共用的 `Error enum` 以標準化錯誤類型。
需處理以下類型的錯誤，並提供對應的 i18n 提示訊息。錯誤訊息主要透過 Toast 提示，持續3秒後自動消失。僅在需要使用者明確回應（如重試操作、重要確認）時考慮使用 Alert。

*   **權限錯誤**: 使用者未授權相簿存取。
*   **讀取錯誤**: 無法讀取照片檔案或其 Metadata。
*   **寫入錯誤**: 無法寫入 Metadata 或儲存檔案（例如，儲存空間不足、檔案鎖定、覆蓋測試失敗）。
*   **格式錯誤**: 初期專注支援 JPG, PNG, JPEG。遇到其他格式 (如 HEIC) 或無法識別的格式時，應透過 Toast 提示使用者「格式暫不支援」。
*   **未知錯誤**: 其他未預期錯誤。

每個錯誤應包含清晰的描述，以便於 Debug 和使用者理解。

## 7. 常數定義

(移至 `Config.swift`，此處僅為提醒)
*   `PhotoStory.METADATA_KEY = "ai.album.story"`

## 8. 核心技術決策

*   **非同步操作**: 所有照片讀取與寫入操作均應採用 `async/await` 進行非同步處理，以避免阻塞主線程並提升 UI 流暢度。
*   **快取機制**: 現階段暫不實作 Metadata 或 `PhotoStory` 物件的快取機制。未來可視效能瓶頸再行評估。
*   **輸入限制**: 使用者輸入故事內容時，UI 層應即時檢查並阻止輸入超過 300 字。
*   **載入指示**: 所有觸發儲存的操作，皆須顯示明確的載入指示器 (Activity Indicator)，直到操作完成 (成功或失敗)。

## 9. 未來考量 (Scope Out)

*   目前不支援批次處理。
*   不支援搜尋功能。
*   不支援分享功能。
*   不支援歷史紀錄功能。

---
文件結束 